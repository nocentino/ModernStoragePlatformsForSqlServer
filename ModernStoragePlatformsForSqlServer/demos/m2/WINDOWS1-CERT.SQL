CREATE MASTER KEY ENCRYPTION BY PASSWORD = 'Strong Password';
GO
CREATE CERTIFICATE WINDOWS1_Cert 
	WITH SUBJECT = 'WINDOWS1 Certificate',
	EXPIRY_DATE='08/18/2031';
GO
BACKUP CERTIFICATE WINDOWS1_Cert 
    TO FILE =  '\\WINDOWS2\BACKUP\WINDOWS1_Cert.cer'
    WITH PRIVATE KEY ( FILE =  '\\WINDOWS2\BACKUP\WINDOWS1_Cert.key' ,   
    ENCRYPTION BY PASSWORD = '997jkhUbhk$w4ez0876hKHJH5gh' );  

GO
CREATE LOGIN WINDOWS2_Login WITH PASSWORD = 'Strong Password';
GO
CREATE USER WINDOWS2_User FOR LOGIN WINDOWS2_Login;
GO
CREATE CERTIFICATE [WINDOWS2_Cert]   
	AUTHORIZATION WINDOWS2_User
    FROM FILE = '\\WINDOWS2\BACKUP\WINDOWS2_Cert.cer'
    WITH PRIVATE KEY (FILE = '\\WINDOWS2\BACKUP\WINDOWS2_Cert.key',   
    DECRYPTION BY PASSWORD = '997jkhUbhk$w4ez0876hKHJH5gh');  
GO

CREATE ENDPOINT DIAG_EP
STATE = STARTED
AS TCP (   
	LISTENER_PORT = 5022,
	LISTENER_IP = ALL
      )
FOR DATABASE_MIRRORING (
	AUTHENTICATION = CERTIFICATE WINDOWS2_Cert,

	ROLE = ALL
      )
GO
GRANT CONNECT ON ENDPOINT::DIAG_EP TO [WINDOWS2_Login];
GO




drop certificate WINDOWS2_cert
drop certificate WINDOWS1_cert
drop login WINDOWS2_login
drop user WINDOWS2_user
